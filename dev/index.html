<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>HOMEDEPOT TEST</title>
        <meta name="viewport" content="initial-scale=1 maximum-scale=1 user-scalable=0 minimal-ui" />
        
        <script src="js/lib/howler.min.js" type="text/javascript"></script>
        <script src="js/lib/phaser.2.13.2.min.js" type="text/javascript"></script>
        <script src="js/boot.js" type="text/javascript"></script>
        <script src="js/preload.js" type="text/javascript"></script>
        <script src="js/thegame.js" type="text/javascript"></script>
        <script src="js/level2.js" type="text/javascript"></script>
        <script src="js/level3.js" type="text/javascript"></script>
        <script src="js/lib/jquery-3.4.1.min.js" type="text/javascript"></script>
       
        <style>
            body {
                margin: 0px;
                padding: 0px;
                font-family: Blender-Pro-Heavy;
                font-size: 14px;
                background-color: #ffffff;
                color: #000000;
            }
            #hiddenfont{ display:none; }

        </style>
        <script>
           
            // variables for use in game can be set here


            // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            // Start - LMS integration code
            // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            
            function initializeParams() {

                this.params             = { };                             // { param1: val1,.. } from query string
                this.delayTimer         = null;                            // in case learner not targeted

                // does the source contain actionable text?
                this.hasText = function( src ) {
                    return ( ( ( typeof src ) == "string" ) && ( src.trim() != "" ) );
                }

                // Return a regular expression suitable for extracting name/value pairs from the query string. 
                this.queryStringPattern = function () {
                    return /[&\?]([^=]+)=([^&]*)/g;
                }

                // return an associative array relating expected query variables to their default values (if any)
                this.queryStringDefaults = function () {
                    return {
                        "TenureMonth"          : "",
                        "JobCode"              : "",
                        "DepartmentCode"       : "",
                        "Role"                 : "Associate",
                        "ToolTownScoreYTD"     : "0",
                        "StoreCode"            : "0000",
                        "FacilityCode"         : "0000",
                        "DistrictCode"         : "0000",
                        "RegionCode"           : "0000",
                        "DivisionCode"         : "0000",
                        "PlatformCode"         : "",
                        "LanguageCode"         : "EN",
                        "CountryCode"          : "US",
                        "Username"             : null,
                        "UserID"               : null,
                        "PostDataUrl"          : "api/gameresults/submit",
                        "CompletedRedirectUrl" : "default.aspx"
                    };
                }

                // Find all the key/value pairs in the query string, and return them as a javascript object.
                // The values will be untyped strings.
                this.queryStringPairs = function () {
                    var key;                                                    // key from query string
                    var val;                                                    // value from query string
                    var match;                                                  // regular expression match
                    var qsHash = { };                                           // { key1: val1, ... }
                    var src    = window.location.search;                        // includes initial '?'
                    var qsPatt = this.queryStringPattern();
                    while( match = qsPatt.exec( src ) ) {
                        key = decodeURIComponent( match[ 1 ] );
                        val = decodeURIComponent( match[ 2 ] );
                        qsHash[ key ] = val;
                    }
                    return qsHash;
                }

                this.params = this.queryStringDefaults();                       // { key: default value }
                var qsHash  = this.queryStringPairs();                          // { key: value }
                for ( var qsKey in qsHash ) {
                    this.params[ qsKey ] = qsHash[ qsKey ];                     // override defaults
                }
            }

            function submitResults(gameResults) {

                // if the CompletedRedirectUrl exists, change the window location to that URL
                this.returnToLms = function () {
                    if ( this.hasText( this.params[ "CompletedRedirectUrl" ] ) ) {
                        window.location.href = this.params[ "CompletedRedirectUrl" ];
                    }
                }

                this.submitResultsFailure = function (jqXhr, status, errText) {

                    // TO DO: up to three retries, then abort the request
                    // Do not complete the module when aborting

                    if ( status == "timeout" ) {                                
                        // if timeout, kill the request
                        jqXhr.onreadystatechange = null;
                        jqXhr.abort();
                    }
                    
                    this.returnToLms();
                }

                this.submitResultsDone = function (data, status, jqXhr) {
                    this.returnToLms();
                }            


                if (this.hasText(this.params[ "PostDataUrl" ])) {

                    // CompletedRedirectURL contains the UserModuleID
                    // Pass the game results JSON as a string inside the LMS data JSON

                    var lmsData = {
                        gameCode: "April2020Interactive",
                        resultsDoc: JSON.stringify(gameResults),
                        userModuleID: this.params["CompletedRedirectUrl"].split('/').pop()
                    };

                    this.params["PostDataUrl"] = "/api/gameresults/submit";

                    // Get the request verification token
                    // Start from the parent document because this content window is inside an i-frame

                    var form = $('#masterForm', window.parent.document);
                    var token = $('input[name="__RequestVerificationToken"]', form).val();

                    console.log("found request verification token: [" + token + "]");

                    console.log("calling " + this.params[ "PostDataUrl" ]);
                    $.ajax( {
                        url: this.params["PostDataUrl"],
                        type: 'POST',
                        contentType: "application/json",
                        dataType: "json",
                        headers: { 'X-XSRF-Token': token },
                        data: JSON.stringify(lmsData),
                        timeout: 15 * 1000,                                 
                        xhrFields: { withCredentials: true },
                        error: this.submitResultsFailure.bind(this),
                        success: this.submitResultsDone.bind(this)
                    } );
                }

            }

            // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
            // End - LMS integration code
            // ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~








           
            // functions called from game
            function endgame(timeLevel1,attemptsLevel1,timeLevel2,attemptsLevel2,timeLevel3,attemptsLevel3){

                console.log("endgame in DOM");

                var gameResults = {
                    level1: {
                        time: timeLevel1,
                        attempts: attemptsLevel1
                    },
                    level2: {
                        time: timeLevel2,
                        attempts: attemptsLevel2
                    },
                    level3: {
                        time: timeLevel3,
                        attempts: attemptsLevel3
                    }
                };

                console.log(gameResults);

                submitResults(gameResults);
            }

            // game setup.  canvas is injected into 'safety-game' div            
            var game;
            (function() {
                game = new Phaser.Game(960, 540, Phaser.CANVAS, 'safety-game');
                
                initializeParams();

                var shortCircuit = true;

                if (shortCircuit) {
                    endgame(1,1,2,2,3,3);
                }
                else {
                    game.state.add("Boot",boot);
                    game.state.add("Preload",preload);
                    game.state.add("TheGame",theGame);
                    game.state.add("Level2",level2);
                    game.state.add("Level3",level3);                             
                    game.global = {soundtrackAudio: false};
                    game.state.start("Boot");
                }

            })();




        </script>
    </head>
    <body>

        <div id="safety-game"></div>
    
    </body>
</html>